Сценарий 4: Генерация аналитического отчета для руководства сети
ID: UC-004
Триггер: Администратор сети запрашивает аналитический отчет за период

Предусловия:

Пользователь аутентифицирован с ролью ADMIN или REPORT_VIEWER

Доступны исторические данные за запрашиваемый период

Сервис аналитики доступен

Основной поток:

Инициирование формирования отчета

Пользователь выбирает параметры отчета:

Тип отчета: SALES, INVENTORY, PERFORMANCE, или CUSTOM

Период: диапазон дат с фильтрацией по часам/дням/неделям

Масштаб: сеть/отдельная точка/регион

Формат вывода: HTML (обязательный), PDF (опционально)

Нажимает "Сформировать отчет"

Валидация и подготовка

Проверка прав доступа к запрашиваемым данным

Верификация корректности временного диапазона (не более 365 дней)

Созрение асинхронной задачи формирования отчета с уникальным taskId

Сбор и агрегация данных

Параллельные запросы к:

Order Service: статистика заказов, средний чек, популярные товары

Inventory Service: оборот ингредиентов, стоимость остатков

Point Service: загрузка точек, время выполнения заказов

Payment Service: финансовые показатели, возвраты

Агрегация данных в промежуточном хранилище (OLAP-куб)

Применение бизнес-правил и расчетов

Расчет метрик:

Конверсия заказов

Маржинальность по категориям товаров

Коэффициент использования ингредиентов

Затраты на логистику (для доставки)

Выполнение анализа чувствительности для ключевых показателей

Генерация визуализаций

Создание графиков (тренды, сравнение, распределение)

Формирование сводных таблиц с детализацией

Подготовка тепловых карт загруженности точек

Компиляция отчета

Сборка HTML-отчета с семантической разметкой

Применение корпоративного шаблона (логотип, цвета, шрифты)

Добавление метаданных: дата генерации, версия отчета, ответственный

Генерация PDF через headless browser (при запросе)

Уведомление о готовности

Отправка email со ссылкой на скачивание отчета

Сохранение отчета в файловом хранилище с TTL=30 дней

Обновление статуса задачи на COMPLETED

Постусловия:

Отчет доступен для скачивания

Метрики генерации записаны в лог (время выполнения, объем данных)

Кэшированные данные агрегации очищены через 24 часа

Альтернативные потоки:

A1: Недостаточные права доступа

Система возвращает ошибку 403 FORBIDDEN

Отображается уведомление о необходимости дополнительных привилегий

A2: Превышение лимита периода

При запросе >365 дней система предлагает уменьшить диапазон

Автоматическая разбивка на несколько отчетов с квартальной детализацией

A3: Отсутствие данных за период

Возвращается отчет с нулевыми значениями и пояснением

Предлагается выбрать альтернативный период

A4: Таймаут генерации

При обработке >10 минут отправляется промежуточный отчет

Полный отчет догенерируется асинхронно и отправляется отдельно

Технические детали:

Архитектура: Event-driven с использованием Apache Spark для агрегации больших данных

Хранение: Отчеты сохраняются в S3-совместимом хранилище с версионированием

Кэширование: Промежуточные агрегаты кэшируются в Redis на 24 часа

Асинхронность: Celery/RabbitMQ для фоновой генерации отчетов

Структура отчета:

html
1. Титульная страница (название, период, ответственный)
2. Executive Summary (ключевые выводы)
3. Входные параметры и методология
4. Результаты расчетов (таблицы с метриками)
5. Анализ чувствительности по 3 сценариям (оптимистичный/реалистичный/пессимистичный)
6. Визуализации (графики, диаграммы, тепловые карты)
7. Рекомендации на основе выявленных паттернов
8. Приложения (сырые данные, формулы расчетов)
Интеграции:

Data Lake (сырые данные)

Email Service (отправка отчетов)

File Storage (S3/MinIO)

Analytics Engine (Apache Spark/Presto)

Template Engine (Jinja2 для HTML)

Метрики успешности:

Время генерации отчета до 50К транзакций: <5 минут

Доступность сервиса отчетности: 99.5%

Точность расчетов: 100% (верификация через контрольные суммы)
