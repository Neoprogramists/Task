Сценарий: Оформление заказа с самовывозом
ID: UC-001
Триггер: Пользователь завершает формирование корзины товаров и нажимает "Оформить заказ"

Предусловия:

Пользователь аутентифицирован в системе

Корзина содержит ≥1 товар

Выбрана точка самовывоза

Точка находится в рабочем статусе

Основной поток:

Валидация бизнес-правил

Проверка доступности товаров в инвентаре выбранной точки

Верификация времени работы точки

Расчет итоговой суммы с учетом акций

Создание ордера

Генерация уникального номера заказа

Создание сущности Order в статусе CREATED

Привязка к пользовательской сессии

Инициирование платежа

Вызов платежного шлюза с параметрами {orderId, amount, userId}

Получение sessionId для клиентской стороны

Обновление статуса заказа на AWAITING_PAYMENT

Обработка клиентской оплаты

Редирект пользователя на платежную форму

Асинхронная обработка webhook от платежного шлюза

При успехе - статус PAID, при неудаче - PAYMENT_FAILED

Передача на исполнение

Отправка события OrderPaid в очередь сообщений

Получение события сервисом кухни

Обновление статуса на IN_PROGRESS в точке приготовления

Обновление инвентаря

Синхронный вызов InventoryService для резервирования ингредиентов

Запись транзакции списания

Уведомление пользователя

Отправка push-уведомления с номером заказа и примерным временем готовности

Обновление UI клиентского приложения

Подготовка заказа

Отображение заказа на кухонном дисплее

Поэтапное обновление статусов: PREPARING → READY

Выдача заказа

Сканирование QR-кода или ввод номера заказа кассиром

Обновление статуса на COMPLETED

Отправка чека на email пользователя

Постусловия:

Заказ помечен как выполненный

Инвентарь обновлен

Время выполнения заказа зафиксировано в метриках

Данные доступны для аналитики

Альтернативные потоки:

A1: Отмена до оплаты

Пользователь отменяет заказ до подтверждения платежа

Статус меняется на CANCELLED_BY_USER

Освобождение зарезервированных товаров в инвентаре

A2: Неудачная оплата

Платежный шлюз возвращает ошибку

Заказ переходит в статус PAYMENT_FAILED

Пользователю предлагается повторить попытку

Автоматический переход в CANCELLED через 15 минут

A3: Товар недоступен

InventoryService возвращает недостаточный остаток

Пользователю предлагается заменить товар или отменить заказ

При отмене - возврат средств по схеме платежного шлюза

A4: Точка не принимает заказы

Проверка выявляет точку в статусе SUSPENDED или CLOSED

Пользователю предлагается выбрать другую точку

Заказ не создается

Технические детали:

Временные ограничения: Весь процесс должен укладываться в 30 секунд для шагов 1-4

Идемпотентность: Все операции с заказом защищены idempotency key

Консистентность: Используется паттерн SAGA для управления распределенными транзакциями

Наблюдаемость: Каждый шаг логируется с correlationId для отслеживания

Интеграции:

Payment Gateway API (синхронный, HTTPS)

Push Notification Service (асинхронный, очередь)

Inventory Service (синхронный, gRPC)

Analytics Service (асинхронный, события)

Email Service (асинхронный, очередь)

Метрики успешности:

Время от нажатия "Оформить" до получения номера заказа: <3 секунд

Процент успешных платежей с первой попытки: >95%

Время от оплаты до уведомления пользователя: <2 секунд
